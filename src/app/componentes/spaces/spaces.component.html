  <div class="row g-3 align-items-end mb-3">

      <div class="d-flex align-items-center justify-content-between mb-3">
      <!--h1-- class="app-header h3 m-0">Gestión de Autolavado-Parking — Bosquejo</!--h1-->
          <img src="../assets/logo/logo_autolvadao.jpg" alt="Logo Autolavado" class="img-fluid" style="max-height: 50px;">
      <div>
        <button  class="btn btn-outline-light btn-sm" (click)="resetData()" title="Borrar todo (demo)">Limpiar datos</button>
      </div>
    </div>
    <!--div-- class="d-flex justify-content-end mb-3">
  <button class="btn btn-outline-light btn-sm" title="Borrar todo (demo)" (click)="resetData()">Limpiar datos</button>
</!--div-->
<hr>

      <div class="col-12 col-md-4">
        <div class="input-group">
          <select class="form-select" [(ngModel)]="currentSubId" (change)="onSubsueloChange()">
            <option *ngFor="let sub of subsuelos" [value]="sub.id">{{sub.label}}</option>
          </select>
          <button class="btn btn-success" (click)="addSubsuelo()">+ Subsuelo</button>
          <button class="btn btn-danger" (click)="deleteSubsuelo()">- Subsuelo</button>
        </div>
        <div class="form-text">Podés crear o eliminar varios subsuelos (SUB1, SUB2, ...).</div>

      </div>
      <div class="col-12 col-md-4">
        <!--label-- class="form-label">Agregar espacios al subsuelo actual</!--label-->
        <div class="input-group">
          <input type="number" class="form-control" min="1" [(ngModel)]="addSpacesCount" value="5">
          <button class="btn btn-primary" (click)="addSpaces()">+ Espacios</button>
          <button class="btn btn-danger" (click)="deleteSpaces()">- Espacios</button>
        </div>

        <div class="form-text">Los códigos siguen el patrón <span class="code-badge">SUBN-###</span>.</div>
      </div>
      <div class="col-12 col-md-4">
       <div class="input-group">
            <input class="form-control"
               placeholder="Nombre del espacio"
               [(ngModel)]="searchTerm"
               (input)="onSearch()" />
       </div>

                <!--label-- class="form-label">Buscar cliente / espacio</!--label-->
                <div class="form-text">Buscar espacio por nombre</div>
      </div>
    </div>

    <!-- Spaces Grid -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <!--h2-- class="h5 m-0">{{currentSubTitle}}</!--h2-->
        <h2 class="h5 m-0" (click)="editSubsuelo()"
    style="cursor: pointer; user-select: none;"
    data-bs-toggle="tooltip"
    data-bs-placement="top"
    title="Desea editar el subsuelo?">
  {{currentSubTitle}}
</h2>

          <div class="tiny">Click en un espacio libre para cargar cliente. Click en ocupado para ver/gestionar.</div>
        </div>
        <hr>
        <div class="grid">
          <div *ngFor="let space of filteredSpaces"
               class="d-flex flex-column align-items-center"
               [class.search-hit]="isSearchHit(space)">
            <button class="btn btn-space"
                    [class.btn-free]="!space.occupied && !space.hold"
                    [class.btn-occ]="space.occupied"
                    [class.btn-hold]="space.hold"
                    (click)="onSpaceClick(space)">
              {{space.displayName || space.key}}
              <!--i-- class="bi bi-pencil edit-icon" title="Editar espacio"  ></!--i-->
              <i class="bi bi-pencil edit-icon" title="Editar espacio" (click)="editSpace(space); $event.stopPropagation()"></i>
            </button>

            <div class="elapsed">
              {{space.occupied ? 'Tiempo: ' + getElapsed(space.startTime) : 'Libre'}}
            </div>
          </div>
        </div>
  <div class="d-flex justify-content-center mt-3" *ngIf="totalPages > 1">
      <nav aria-label="Paginación de espacios">
        <ul class="pagination">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="prevPage()">Anterior</button>
          </li>
          <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
              [class.active]="currentPage === i + 1">
            <button class="page-link" (click)="goToPage(i + 1)">{{i + 1}}</button>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link" (click)="nextPage()">Siguiente</button>
          </li>
        </ul>
      </nav>
    </div>

      </div>
    </div>

    <!-- Legend -->
    <div class="d-flex gap-2 flex-wrap small mb-5">
      <span class="badge" style="background:#0ea5e9">Libre</span>
      <span class="badge" style="background:#ef4444">Ocupado</span>
      <span class="badge" style="background:#f59e0b">Reservado / retenido</span>
    </div>

    <button class="btn btn-primary btn-lg position-fixed" style="bottom: 20px; right: 20px; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1050;" onclick="window.open('https://orbitasoftware.site/', '_blank')">
  <i class="bi bi-box-arrow-up-right" style="font-size: 24px; color: white;"></i>
</button>

    <!-- Client Modal -->
    <div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modal-dark">
          <div class="modal-header">
            <h5 class="modal-title">
              Asignar cliente a <span class="code-badge">{{selectedSpaceKey}}</span>
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="clientForm" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre y apellido *</label>
                <input formControlName="name" class="form-control form-control-dark" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Teléfono (Argentina) *</label>
                <input formControlName="phone" class="form-control form-control-dark"
                       placeholder="Ej: 11 1234 5678" required />
                <div class="form-text">Se formatea a +54 (sin 0 ni 15).</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Tipo de vehículo (opcional)</label>
                <input formControlName="vehicle" class="form-control form-control-dark"
                       placeholder="Sedán, SUV, Moto…" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Matrícula / Patente (opcional)</label>
                <input formControlName="plate" class="form-control form-control-dark"
                       placeholder="AA123BB / ABC123" />
              </div>
              <div class="col-12">
                <label class="form-label">Notas (opcional)</label>
                <input formControlName="notes" class="form-control form-control-dark"
                       placeholder="Color, observaciones" />
              </div>
            </form>
            <hr />
            <div class="row g-3">

              <div class="col-md-12 d-grid d-md-flex gap-2">
                  <button class="btn btn-primary flex-fill btn-sm d-block d-md-inline-block" (click)="saveClient()" [disabled]="clientForm.invalid">
                  Ocupar espacio
                </button>
  <button class="btn btn-outline-secondary flex-fill btn-sm d-block d-md-inline-block" (click)="toggleQR()">
    Ver QR Previo
  </button>
  <button *ngIf="whatsappLink" class="btn btn-success flex-fill btn-sm d-block d-md-inline-block" (click)="openWhatsApp()">
    WhatsApp
  </button>
  <button class="btn btn-danger flex-fill btn-sm d-block d-md-inline-block" (click)="deleteSpace()">
    Eliminar
  </button>
  <button class="btn btn-info flex-fill btn-sm d-block d-md-inline-block" (click)="transferSpace()">
    Transferir Espacio
  </button>
</div>
            </div>
            <div class="mt-3" *ngIf="showQR">
              <div class="border rounded p-3 bg-white text-center">
                <div id="qrcode"></div>
                <div class="small text-dark mt-2">{{qrCaption}}</div>
                <button class="btn btn-sm btn-outline-dark mt-2" (click)="downloadQR()">
                  Descargar QR
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Occupied Modal -->
    <div class="modal fade" id="occupiedModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modal-dark">
          <div class="modal-header">
            <h5 class="modal-title">Espacio <span class="code-badge">{{selectedSpaceKey}}</span></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div *ngIf="selectedClient" class="client-info">
              <div class="row g-2 small">
                <div class="col-md-6">
                  <label>Cliente:</label>
                  <span>{{selectedClient.name}}</span>
                  <span class="badge bg-secondary ms-2">{{selectedClient.code}}</span>
                </div>
                <div class="col-md-6">
                  <label>Teléfono:</label>
                  <span>+{{selectedClient.phoneIntl}}</span>
                </div>
                <div class="col-md-4">
                  <label>Vehículo:</label>
                  <span>{{selectedClient.vehicle || '-'}}</span>
                </div>
                <div class="col-md-4">
                  <label>Matrícula:</label>
                  <span>{{selectedClient.plate || '-'}}</span>
                </div>
                <div class="col-md-4">
                  <label>Ingreso:</label>
                  <span>{{getFormattedDate(selectedSpace?.startTime)}}</span>
                </div>
                <div class="col-12">
                  <label>Notas:</label>
                  <span>{{selectedClient.notes || '-'}}</span>
                </div>
              </div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <a *ngIf="whatsappLink" [href]="whatsappLink" target="_blank" class="btn btn-success">
                WhatsApp
              </a>
              <button class="btn btn-outline-secondary" (click)="toggleOccupiedQR()">Ver QR</button>
              <button class="btn btn-danger ms-auto" (click)="releaseSpace()">Liberar espacio</button>
            </div>
            <div class="mt-3" *ngIf="showOccupiedQR">
              <div class="border rounded p-3 bg-white text-center">
                <div id="occQRElm"></div>
                <div class="small text-dark mt-2" >{{qrCaption}}</div>
                <button class="btn btn-sm btn-outline-dark mt-2" (click)="downloadOccupiedQR()">
                  Descargar QR
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!--div-- class="modal fade" id="editSpaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content modal-dark">
      <div class="modal-header">
        <h5 class="modal-title">Editar Espacio</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Nueva Clave del Espacio</label>
          <input type="text" class="form-control form-control-dark" [(ngModel)]="newSpaceKey" placeholder="Ej: SUB1-ABC">
          <div class="form-text">La clave debe ser única y seguir el patrón SUBN-###.</div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-fill" (click)="confirmEditSpace()">Guardar Cambios</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</!--div-->


<!--div-- class="modal fade" id="editSpaceModal" tabindex="-1" aria-hidden="true" *ngIf="editedSpace" >
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content modal-dark">
      <div class="modal-header">
        <h5 class="modal-title">Editar Espacio</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="editedSpace">
        <div class="mb-3">
          <label class="form-label">Clave del Espacio</label>
          <input type="text" class="form-control form-control-dark" [value]="editedSpace.key" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label">Nombre Visible</label>
          <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.displayName" placeholder="Ej: Parking VIP">
        </div>
        <div class="mb-3" *ngIf="editedSpace.client">
          <label class="form-label">Nombre del Cliente</label>
          <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.client.name" placeholder="Nombre del cliente">
        </div>
         <div class="mb-3">
          <label class="form-label">Telefono</label>
           <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.client.phoneIntl" placeholder="+54 9 11 1234 5678">
        </div>
        <div class="mb-3" *ngIf="editedSpace.client">
          <label class="form-label">Notas del Cliente</label>
          <textarea class="form-control form-control-dark" [(ngModel)]="editedSpace.client.notes" rows="2" placeholder="Notas del cliente"></textarea>
        </div>
        <div class="row g-2 mb-3" *ngIf="editedSpace.client">
          <div class="col-6">
            <label class="form-label">Vehículo</label>
            <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.client.vehicle" placeholder="Ej: Toyota Corolla">
          </div>
          <div class="col-6">
            <label class="form-label">Placa</label>
            <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.client.plate" placeholder="Ej: ABC123">
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-fill" (click)="confirmEditSpace()">Guardar Cambios</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</!--div-->



<div class="modal fade" id="editSpaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content modal-dark">
      <div class="modal-header">
        <h5 class="modal-title">Editar Espacio</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="editedSpace">
        <div class="mb-3">
          <label class="form-label">Clave del Espacio</label>
          <input type="text" class="form-control form-control-dark" [value]="editedSpace.key" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Nombre Visible</label>
          <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.displayName" placeholder="Ej: Parking VIP">
        </div>
        <div class="mb-3" *ngIf="editedSpace.client">
          <label class="form-label">Nombre del Cliente</label>
          <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.client.name" placeholder="Nombre del cliente">
        </div>
        <div class="mb-3" *ngIf="editedSpace.client">
          <label class="form-label">Teléfono</label>
          <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.client.phoneIntl" placeholder="+54 9 11 1234 5678">
        </div>
        <div class="mb-3" *ngIf="editedSpace.client">
          <label class="form-label">Notas del Cliente</label>
          <textarea class="form-control form-control-dark" [(ngModel)]="editedSpace.client.notes" rows="2" placeholder="Notas del cliente"></textarea>
        </div>
        <div class="row g-2 mb-3" *ngIf="editedSpace.client">
          <div class="col-6">
            <label class="form-label">Vehículo</label>
            <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.client.vehicle" placeholder="Ej: Toyota Corolla">
          </div>
          <div class="col-6">
            <label class="form-label">Placa</label>
            <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSpace.client.plate" placeholder="Ej: ABC123">
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-fill" (click)="confirmEditSpace()">Guardar Cambios</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editSubsueloModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content modal-dark">
      <div class="modal-header">
        <h5 class="modal-title">Editar Subsuelo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="currentSubId">
        <div class="mb-3">
          <label class="form-label">Nombre del Subsuelo</label>
          <input type="text" class="form-control form-control-dark" [(ngModel)]="editedSubsueloLabel" placeholder="Ej: Subsuelo Premium">
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-fill" (click)="confirmEditSubsuelo()">Guardar Cambios</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>
