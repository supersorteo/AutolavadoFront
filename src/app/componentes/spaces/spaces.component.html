  <div class="row g-3 align-items-end mb-3">

      <div class="d-flex align-items-center justify-content-between mb-3">
      <!--h1-- class="app-header h3 m-0">Gestión de Autolavado-Parking — Bosquejo</!--h1-->
          <img src="../assets/logo/logo_autolvadao.jpg" alt="Logo Autolavado" class="img-fluid" style="max-height: 50px;">
      <div>
        <button  class="btn btn-outline-light btn-sm" (click)="resetData()" title="Borrar todo (demo)">Limpiar datos</button>
      </div>
    </div>
    <!--div-- class="d-flex justify-content-end mb-3">
  <button class="btn btn-outline-light btn-sm" title="Borrar todo (demo)" (click)="resetData()">Limpiar datos</button>
</!--div-->
<hr>

      <div class="col-12 col-md-4">
        <div class="input-group">
          <select class="form-select" [(ngModel)]="currentSubId" (change)="onSubsueloChange()">
            <option *ngFor="let sub of subsuelos" [value]="sub.id">{{sub.label}}</option>
          </select>
          <button class="btn btn-success" (click)="addSubsuelo()">+ Subsuelo</button>
        </div>
        <div class="form-text">Podés crear varios subsuelos (SUB1, SUB2, ...).</div>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">Agregar espacios al subsuelo actual</label>
        <div class="input-group">
          <input type="number" class="form-control" min="1" [(ngModel)]="addSpacesCount" value="5">
          <button class="btn btn-primary" (click)="addSpaces()">+ Espacios</button>
        </div>

        <div class="form-text">Los códigos siguen el patrón <span class="code-badge">SUBN-###</span>.</div>
      </div>
      <div class="col-12 col-md-4">
       <div class="input-group">
            <input class="form-control"
               placeholder="Nombre, teléfono, vehículo, matrícula o código (p.ej. SUB1-001)"
               [(ngModel)]="searchTerm"
               (input)="onSearch()" />
       </div>

                <!--label-- class="form-label">Buscar cliente / espacio</!--label-->
                <div class="form-text">Buscar cliente / espacio</div>
      </div>
    </div>

    <!-- Spaces Grid -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 m-0">{{currentSubTitle}}</h2>
          <div class="tiny">Click en un espacio libre para cargar cliente. Click en ocupado para ver/gestionar.</div>
        </div>
        <hr>
        <div class="grid">
          <div *ngFor="let space of filteredSpaces"
               class="d-flex flex-column align-items-center"
               [class.search-hit]="isSearchHit(space)">
            <button class="btn btn-space"
                    [class.btn-free]="!space.occupied && !space.hold"
                    [class.btn-occ]="space.occupied"
                    [class.btn-hold]="space.hold"
                    (click)="onSpaceClick(space)">
              {{space.key}}
            </button>
            <div class="elapsed">
              {{space.occupied ? 'Tiempo: ' + getElapsed(space.startTime) : 'Libre'}}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="d-flex gap-2 flex-wrap small mb-5">
      <span class="badge" style="background:#0ea5e9">Libre</span>
      <span class="badge" style="background:#ef4444">Ocupado</span>
      <span class="badge" style="background:#f59e0b">Reservado / retenido</span>
    </div>

    <!-- Client Modal -->
    <div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modal-dark">
          <div class="modal-header">
            <h5 class="modal-title">
              Asignar cliente a <span class="code-badge">{{selectedSpaceKey}}</span>
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="clientForm" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre y apellido *</label>
                <input formControlName="name" class="form-control form-control-dark" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Teléfono (Argentina) *</label>
                <input formControlName="phone" class="form-control form-control-dark"
                       placeholder="Ej: 11 1234 5678" required />
                <div class="form-text">Se formatea a +54 (sin 0 ni 15).</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Tipo de vehículo (opcional)</label>
                <input formControlName="vehicle" class="form-control form-control-dark"
                       placeholder="Sedán, SUV, Moto…" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Matrícula / Patente (opcional)</label>
                <input formControlName="plate" class="form-control form-control-dark"
                       placeholder="AA123BB / ABC123" />
              </div>
              <div class="col-12">
                <label class="form-label">Notas (opcional)</label>
                <input formControlName="notes" class="form-control form-control-dark"
                       placeholder="Color, observaciones" />
              </div>
            </form>
            <hr />
            <div class="row g-3">
              <div class="col-md-6">
                <button class="btn btn-primary w-100" (click)="saveClient()" [disabled]="clientForm.invalid">
                  Guardar y ocupar espacio
                </button>
              </div>
              <div class="col-md-6 d-grid d-md-flex gap-2">
                <button class="btn btn-outline-secondary flex-fill" (click)="toggleQR()">
                  Ver QR Previo
                </button>
                <!--a *ngIf="whatsappLink" [href]="whatsappLink" target="_blank"
                   class="btn btn-success flex-fill">Enviar por WhatsApp</a-->

                    <button *ngIf="whatsappLink" class="btn btn-success flex-fill" (click)="openWhatsApp()">
              Enviar por WhatsApp
            </button>

              </div>
            </div>
            <div class="mt-3" *ngIf="showQR">
              <div class="border rounded p-3 bg-white text-center">
                <div id="qrcode"></div>
                <div class="small text-dark mt-2">{{qrCaption}}</div>
                <button class="btn btn-sm btn-outline-dark mt-2" (click)="downloadQR()">
                  Descargar QR
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Occupied Modal -->
    <div class="modal fade" id="occupiedModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modal-dark">
          <div class="modal-header">
            <h5 class="modal-title">Espacio <span class="code-badge">{{selectedSpaceKey}}</span></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div *ngIf="selectedClient" class="client-info">
              <div class="row g-2 small">
                <div class="col-md-6">
                  <label>Cliente:</label>
                  <span>{{selectedClient.name}}</span>
                  <span class="badge bg-secondary ms-2">{{selectedClient.code}}</span>
                </div>
                <div class="col-md-6">
                  <label>Teléfono:</label>
                  <span>+{{selectedClient.phoneIntl}}</span>
                </div>
                <div class="col-md-4">
                  <label>Vehículo:</label>
                  <span>{{selectedClient.vehicle || '-'}}</span>
                </div>
                <div class="col-md-4">
                  <label>Matrícula:</label>
                  <span>{{selectedClient.plate || '-'}}</span>
                </div>
                <div class="col-md-4">
                  <label>Ingreso:</label>
                  <span>{{getFormattedDate(selectedSpace?.startTime)}}</span>
                </div>
                <div class="col-12">
                  <label>Notas:</label>
                  <span>{{selectedClient.notes || '-'}}</span>
                </div>
              </div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <a *ngIf="whatsappLink" [href]="whatsappLink" target="_blank" class="btn btn-success">
                WhatsApp al cliente
              </a>
              <button class="btn btn-outline-secondary" (click)="toggleOccupiedQR()">Ver QR</button>
              <button class="btn btn-danger ms-auto" (click)="releaseSpace()">Liberar espacio</button>
            </div>
            <div class="mt-3" *ngIf="showOccupiedQR">
              <div class="border rounded p-3 bg-white text-center">
                <div id="occQRElm"></div>
                <div class="small text-dark mt-2">{{qrCaption}}</div>
                <button class="btn btn-sm btn-outline-dark mt-2" (click)="downloadOccupiedQR()">
                  Descargar QR
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
